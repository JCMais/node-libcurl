name: build-lint-test

defaults:
  run:
    shell: bash

on:
  pull_request:


concurrency:
  group: build-lint-test-${{ github.head_ref }}
  cancel-in-progress: true

# all jobs here must have a matrix identical to the ones inside build-and-release.yaml

jobs:
  config:
    uses: ./.github/workflows/reusable-config.yaml

  lint-and-tsc:
    uses: ./.github/workflows/reusable-lint-tsc.yaml

  build-and-test:
    runs-on: ${{ matrix.os == 'alpine' && 'ubuntu-22.04' || matrix.os }}
    container: ${{ matrix.os == 'alpine' && format('node:{0}-alpine3.21', matrix.node) || '' }}
    needs: config
    strategy:
      fail-fast: false
      matrix:
        electron-version:
          - ''
        os:
          - macos-15
          - ubuntu-22.04
          - ubuntu-24.04-arm
          - alpine
          - windows-2025
        libcurl-release:
          - ${{ needs.config.outputs.latest-libcurl-release }}
        node:
          - 25
          - 24
          - 22
        include:
          # we only want to record coverage in one of the jobs, in this case, the one for the latest stable Node.js version
          - os: ubuntu-22.04
            libcurl-release: ${{ needs.config.outputs.latest-libcurl-release }}
            node: 24
            record-coverage: true
          # we also want to build a job for old libcurl versions
          - os: ubuntu-22.04
            libcurl-release: ${{ needs.config.outputs.oldest-libcurl-release }}
            node: 24
    env:
      LIBCURL_RELEASE: ${{ matrix.libcurl-release }}
      LATEST_LIBCURL_RELEASE: ${{ matrix.libcurl-release }}
      ELECTRON_VERSION: ${{ matrix.electron-version }}
      # these are false because we run tests separately
      PUBLISH_BINARY: false
      RUN_TESTS: false
      RUN_PREGYP_CLEAN: false
      GIT_COMMIT: ${{ github.sha }}
      GIT_REF_NAME: ${{ github.ref_name }}
    steps:
      - name: Install updated git (Alpine)
        if: matrix.os == 'alpine'
        shell: sh
        run: |
          apk add --no-cache git bash

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Install System Packages
        uses: ./.github/actions/install-system-packages
    
      # see https://github.com/nodejs/node/issues/40537
      - name: Enforce IPv4 Connectivity
        if: matrix.os != 'alpine'
        uses: ./.github/actions/force-ipv4

      # PNPM / Node.js
      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '${{ matrix.node }}'
          skip-node-setup: ${{ matrix.os == 'alpine' && 'true' || 'false' }}

      - name: Setup Libcurl Cache (Restore, Non-Windows)
        if: runner.os != 'Windows'
        id: libcurl-deps-cache
        uses: ./.github/actions/setup-libcurl-cache
        with:
          libcurl-release: ${{ matrix.libcurl-release }}
          node-version: ${{ matrix.node }}
          electron-version: ${{ matrix.electron-version }}
          electron-config-cache: ${{ needs.config.outputs.electron-config-cache }}
          mode: 'restore-only'

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: matrix.enable-debugging

      - name: 'Build and Package Binary (Non-Windows)'
        if: runner.os != 'Windows'
        run: ./scripts/ci/build.sh

      - name: 'Check if fully installed and built (Non-Windows)'
        id: built-and-installed
        if: runner.os != 'Windows'
        run: |
          if [[ -f built-and-installed.hidden.txt ]]; then
            echo "built-and-installed.hidden.txt exists"
            echo "status=true" >> $GITHUB_OUTPUT
          else
            echo "built-and-installed.hidden.txt does not exist"
            echo "status=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Libcurl Cache (Save, Non-Windows)
        if: runner.os != 'Windows' && steps.libcurl-deps-cache.outputs.cache-hit != 'true' && steps.built-and-installed.outputs.status == 'true'
        uses: ./.github/actions/setup-libcurl-cache
        with:
          libcurl-release: ${{ matrix.libcurl-release }}
          node-version: ${{ matrix.node }}
          electron-version: ${{ matrix.electron-version }}
          electron-config-cache: ${{ needs.config.outputs.electron-config-cache }}
          mode: 'save-only'

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/setup-vcpkg-windows

      - name: 'Build and Package Binary (Windows)'
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/ci/windows/build.ps1

      - name: 'Run tests'
        # no way to run vitest tests using electron's main process, so no point doing this here
        if: matrix.electron-version == ''
        run: pnpm test:coverage

      - name: Upload coverage to Codecov
        if: matrix.record-coverage && matrix.electron-version != ''
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/**
          fail_ci_if_error: false
      
      - name: Upload Build Logs
        if: always() && runner.os != 'Windows'
        uses: ./.github/actions/upload-build-logs
        with:
          artifact-name: build-logs-${{ matrix.os }}-${{ matrix.libcurl-release }}-${{ matrix.electron-version && 'electron' || 'node' }}-${{ matrix.electron-version || matrix.node }}
          retention-days: '3'
